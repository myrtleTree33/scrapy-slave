## This playbook configures Marvin slaves for setup.

- hosts: slaves
  sudo: yes
  vars:
    git_marvin_directory: /root/repos/marvin
    marvin_github_repo_url: https://github.com/myrtleTree33/marvin.git
    mongo_db_uri: mongodb://localhost/test
    sudo_username: root

  tasks:
    - name: install packages
      apt: name={{ item }} update_cache=yes state=latest
      with_items:
        - git
        - vim
        - screen
        - python-pip
        - python3-pip
        - apt-transport-https
        - ca-certificates
        - curl

    - name: Add Docker GPG key
      apt_key: url=https://download.docker.com/linux/ubuntu/gpg
    - name: Add Docker APT repository
      apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ansible_distribution_release}} stable
    - name: Install Docker
      apt: name=docker-ce

    - name: Clone git repository
      git:
        dest: "{{ git_marvin_directory }}"
        repo: "{{ marvin_github_repo_url }}"
        update: yes
      sudo: yes
      sudo_user: "{{ sudo_username }}"

    - name: build the image
      docker_image:
        name: slave
        path: /root/repos/marvin
        state: present
        force: yes # Always build the image when run

    - name: Start 4 load-balanced containers
      docker_container:
        name: "container{{ item }}"
        recreate: yes
        image: slave
        command: sleep 1s
        pull: false # Use local repository build image
        env:
          NUM_NODES: 20
          MONGO_URI: "{{ mongo_db_uri }}"
      with_sequence: count=4
